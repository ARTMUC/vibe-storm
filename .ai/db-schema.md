# MySQL Database Schema for Event Storming to UML Generator

## Implementation Plan
- [x] Analyze requirements for UUID ordering and 2038 timestamp issues
- [x] Update schema to use auto-increment seq_id columns for efficient ordering
- [x] Replace TIMESTAMP with DATETIME to solve 2038 problem
- [x] Add composite indexes on user_id + created_at for user-specific queries
- [x] Update documentation to reflect these changes
- [x] Update migration files to implement the changes

## 1. List of tables with their columns, data types, and constraints

### users
- `id` VARCHAR(36) PRIMARY KEY NOT NULL - Unique identifier for the user (UUID)
- `seq_id` INT AUTO_INCREMENT UNIQUE - Sequential ID for efficient ordering
- `email` VARCHAR(255) UNIQUE NOT NULL - User's email address
- `username` VARCHAR(100) UNIQUE NOT NULL - User's username
- `password_hash` VARCHAR(255) NOT NULL - Hashed password
- `first_name` VARCHAR(100) - User's first name
- `last_name` VARCHAR(100) - User's last name
- `is_active` BOOLEAN DEFAULT TRUE - Whether the user account is active
- `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP - When the user was created
- `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP - When the user was last updated
- `deleted_at` DATETIME NULL DEFAULT NULL - When the user was soft deleted

### user_sessions
- `id` VARCHAR(36) PRIMARY KEY NOT NULL - Unique identifier for the session (UUID)
- `user_id` VARCHAR(36) NOT NULL - Foreign key to users table
- `token` VARCHAR(255) UNIQUE NOT NULL - Session token
- `expires_at` DATETIME NOT NULL - When the session expires
- `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP - When the session was created

### projects
- `id` VARCHAR(36) PRIMARY KEY NOT NULL - Unique identifier for the project (UUID)
- `seq_id` INT AUTO_INCREMENT UNIQUE - Sequential ID for efficient ordering
- `name` VARCHAR(255) NOT NULL - Project name
- `description` TEXT - Project description
- `business_process_text` LONGTEXT - The business process description text
- `owner_user_id` VARCHAR(36) NOT NULL - Foreign key to users table (project owner)
- `is_template` BOOLEAN DEFAULT FALSE - Whether this is a template project
- `miro_board_id` VARCHAR(255) NULL - Miro board identifier
- `miro_export_status` ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending' - Status of Miro export
- `last_miro_export_at` DATETIME NULL DEFAULT NULL - When the project was last exported to Miro
- `ai_processing_status` ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending' - Status of AI processing
- `ai_confidence_score` DECIMAL(5,4) NULL DEFAULT NULL - Confidence score of AI processing
- `last_processed_at` DATETIME NULL DEFAULT NULL - When the project was last processed by AI
- `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP - When the project was created
- `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP - When the project was last updated
- `deleted_at` DATETIME NULL DEFAULT NULL - When the project was soft deleted

### project_users
- `id` VARCHAR(36) PRIMARY KEY NOT NULL - Unique identifier for the relationship (UUID)
- `seq_id` INT AUTO_INCREMENT UNIQUE - Sequential ID for efficient ordering
- `project_id` VARCHAR(36) NOT NULL - Foreign key to projects table
- `user_id` VARCHAR(36) NOT NULL - Foreign key to users table
- `role` ENUM('viewer', 'editor') NOT NULL DEFAULT 'viewer' - User's role in the project
- `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP - When the relationship was created
- `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP - When the relationship was last updated
- `deleted_at` DATETIME NULL DEFAULT NULL - When the relationship was soft deleted

### sticky_notes
- `id` VARCHAR(36) PRIMARY KEY NOT NULL - Unique identifier for the sticky note (UUID)
- `seq_id` INT AUTO_INCREMENT UNIQUE - Sequential ID for efficient ordering
- `project_id` VARCHAR(36) NOT NULL - Foreign key to projects table
- `type` ENUM('domain_event', 'command', 'policy', 'actor') NOT NULL - Type of sticky note
- `content` TEXT NOT NULL - Content of the sticky note
- `x_position` INT DEFAULT 0 - X coordinate on the canvas
- `y_position` INT DEFAULT 0 - Y coordinate on the canvas
- `width` INT DEFAULT 200 - Width of the sticky note
- `height` INT DEFAULT 100 - Height of the sticky note
- `color` VARCHAR(7) NULL DEFAULT NULL - Color of the sticky note
- `is_ai_generated` BOOLEAN DEFAULT TRUE - Whether the note was generated by AI
- `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP - When the note was created
- `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP - When the note was last updated
- `deleted_at` DATETIME NULL DEFAULT NULL - When the note was soft deleted

### note_relationships
- `id` VARCHAR(36) PRIMARY KEY NOT NULL - Unique identifier for the relationship (UUID)
- `seq_id` INT AUTO_INCREMENT UNIQUE - Sequential ID for efficient ordering
- `project_id` VARCHAR(36) NOT NULL - Foreign key to projects table
- `source_note_id` VARCHAR(36) NOT NULL - Foreign key to sticky_notes table (source note)
- `target_note_id` VARCHAR(36) NOT NULL - Foreign key to sticky_notes table (target note)
- `relationship_type` ENUM('triggers', 'implements', 'associated_with') NOT NULL - Type of relationship
- `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP - When the relationship was created
- `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP - When the relationship was last updated
- `deleted_at` DATETIME NULL DEFAULT NULL - When the relationship was soft deleted

### uml_diagrams
- `id` VARCHAR(36) PRIMARY KEY NOT NULL - Unique identifier for the UML diagram (UUID)
- `seq_id` INT AUTO_INCREMENT UNIQUE - Sequential ID for efficient ordering
- `project_id` VARCHAR(36) NOT NULL - Foreign key to projects table
- `diagram_type` ENUM('use_case', 'sequence', 'class') NOT NULL - Type of UML diagram
- `svg_content` LONGTEXT - SVG representation of the diagram
- `plantuml_text` LONGTEXT - PlantUML text representation of the diagram
- `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP - When the diagram was created
- `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP - When the diagram was last updated
- `deleted_at` DATETIME NULL DEFAULT NULL - When the diagram was soft deleted

### notifications
- `id` VARCHAR(36) PRIMARY KEY NOT NULL - Unique identifier for the notification (UUID)
- `seq_id` INT AUTO_INCREMENT UNIQUE - Sequential ID for efficient ordering
- `user_id` VARCHAR(36) NOT NULL - Foreign key to users table
- `project_id` VARCHAR(36) NULL - Foreign key to projects table (optional)
- `message` TEXT NOT NULL - Notification message
- `is_read` BOOLEAN DEFAULT FALSE - Whether the notification has been read
- `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP - When the notification was created
- `read_at` DATETIME NULL DEFAULT NULL - When the notification was read
- `deleted_at` DATETIME NULL DEFAULT NULL - When the notification was soft deleted

### ai_processing_logs
- `id` VARCHAR(36) PRIMARY KEY NOT NULL - Unique identifier for the log entry (UUID)
- `seq_id` INT AUTO_INCREMENT UNIQUE - Sequential ID for efficient ordering
- `project_id` VARCHAR(36) NOT NULL - Foreign key to projects table
- `input_text` LONGTEXT - Input text that was processed
- `processing_time_ms` INT - Processing time in milliseconds
- `result_summary` TEXT - Summary of the processing result
- `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP - When the log entry was created

### project_invitations
- `id` VARCHAR(36) PRIMARY KEY NOT NULL - Unique identifier for the invitation (UUID)
- `seq_id` INT AUTO_INCREMENT UNIQUE - Sequential ID for efficient ordering
- `inviter_user_id` VARCHAR(36) NOT NULL - Foreign key to users table (user who sent the invitation)
- `invitee_email` VARCHAR(255) NOT NULL - Email of the user being invited
- `project_id` VARCHAR(36) NOT NULL - Foreign key to projects table
- `invitation_status` ENUM('pending', 'accepted', 'declined', 'expired') DEFAULT 'pending' - Status of the invitation
- `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP - When the invitation was created
- `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP - When the invitation was last updated
- `expires_at` DATETIME NOT NULL - When the invitation expires

### user_favorites
- `id` VARCHAR(36) PRIMARY KEY NOT NULL - Unique identifier for the favorite (UUID)
- `seq_id` INT AUTO_INCREMENT UNIQUE - Sequential ID for efficient ordering
- `user_id` VARCHAR(36) NOT NULL - Foreign key to users table
- `project_id` VARCHAR(36) NOT NULL - Foreign key to projects table
- `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP - When the favorite was created

## 2. Relationships between tables

1. **users** ←→ **user_sessions** (One-to-Many)
   - One user can have many sessions
   - Foreign key: user_sessions.user_id → users.id

2. **users** ←→ **projects** (One-to-Many, through project_users)
   - Users can be associated with many projects
   - Projects can have many users
   - Foreign keys: project_users.user_id → users.id, project_users.project_id → projects.id

3. **users** ←→ **notifications** (One-to-Many)
   - One user can have many notifications
   - Foreign key: notifications.user_id → users.id

4. **users** ←→ **project_invitations** (One-to-Many)
   - One user can send many invitations
   - Foreign key: project_invitations.inviter_user_id → users.id

5. **users** ←→ **user_favorites** (One-to-Many)
   - One user can have many favorite projects
   - Foreign key: user_favorites.user_id → users.id

6. **projects** ←→ **project_users** (One-to-Many)
   - One project can have many users
   - Foreign key: project_users.project_id → projects.id

7. **projects** ←→ **sticky_notes** (One-to-Many)
   - One project can have many sticky notes
   - Foreign key: sticky_notes.project_id → projects.id

8. **projects** ←→ **note_relationships** (One-to-Many)
   - One project can have many note relationships
   - Foreign key: note_relationships.project_id → projects.id

9. **projects** ←→ **uml_diagrams** (One-to-Many)
   - One project can have many UML diagrams
   - Foreign key: uml_diagrams.project_id → projects.id

10. **projects** ←→ **notifications** (One-to-Many)
    - One project can have many notifications
    - Foreign key: notifications.project_id → projects.id

11. **projects** ←→ **ai_processing_logs** (One-to-Many)
    - One project can have many AI processing logs
    - Foreign key: ai_processing_logs.project_id → projects.id

12. **projects** ←→ **project_invitations** (One-to-Many)
    - One project can have many invitations
    - Foreign key: project_invitations.project_id → projects.id

13. **projects** ←→ **user_favorites** (One-to-Many)
    - One project can be favorited by many users
    - Foreign key: user_favorites.project_id → projects.id

14. **sticky_notes** ←→ **note_relationships** (One-to-Many)
    - One sticky note can be a source in many relationships
    - One sticky note can be a target in many relationships
    - Foreign keys: note_relationships.source_note_id → sticky_notes.id, note_relationships.target_note_id → sticky_notes.id

## 3. Indexes

### users
- PRIMARY KEY (id)
- UNIQUE KEY (seq_id)
- UNIQUE KEY (email)
- UNIQUE KEY (username)
- INDEX idx_users_email (email)
- INDEX idx_users_username (username)
- INDEX idx_users_created_at (created_at)
- INDEX idx_users_deleted_at (deleted_at)

### user_sessions
- PRIMARY KEY (id)
- UNIQUE KEY (token)
- INDEX idx_user_sessions_user_id (user_id)
- INDEX idx_user_sessions_token (token)
- INDEX idx_user_sessions_expires_at (expires_at)

### projects
- PRIMARY KEY (id)
- UNIQUE KEY (seq_id)
- FULLTEXT idx_projects_business_process (business_process_text)
- FULLTEXT idx_projects_name_description (name, description)
- INDEX idx_projects_owner_user_id (owner_user_id)
- INDEX idx_projects_created_at (created_at)
- INDEX idx_projects_deleted_at (deleted_at)
- INDEX idx_projects_is_template (is_template)
- INDEX idx_projects_miro_export_status (miro_export_status)
- INDEX idx_projects_ai_processing_status (ai_processing_status)
- INDEX idx_projects_user_created (owner_user_id, created_at)

### project_users
- PRIMARY KEY (id)
- UNIQUE KEY (seq_id)
- UNIQUE KEY uk_project_user (project_id, user_id)
- INDEX idx_project_users_project_id (project_id)
- INDEX idx_project_users_user_id (user_id)
- INDEX idx_project_users_role (role)
- INDEX idx_project_users_deleted_at (deleted_at)
- INDEX idx_project_users_user_created (user_id, created_at)

### sticky_notes
- PRIMARY KEY (id)
- UNIQUE KEY (seq_id)
- INDEX idx_sticky_notes_project_id (project_id)
- INDEX idx_sticky_notes_type (type)
- INDEX idx_sticky_notes_position (project_id, x_position, y_position)
- INDEX idx_sticky_notes_created_at (created_at)
- INDEX idx_sticky_notes_deleted_at (deleted_at)
- INDEX idx_sticky_notes_project_created (project_id, created_at)

### note_relationships
- PRIMARY KEY (id)
- UNIQUE KEY (seq_id)
- INDEX idx_note_relationships_project_id (project_id)
- INDEX idx_note_relationships_source_note (source_note_id)
- INDEX idx_note_relationships_target_note (target_note_id)
- INDEX idx_note_relationships_type (relationship_type)
- INDEX idx_note_relationships_deleted_at (deleted_at)
- INDEX idx_note_relationships_project_created (project_id, created_at)

### uml_diagrams
- PRIMARY KEY (id)
- UNIQUE KEY (seq_id)
- INDEX idx_uml_diagrams_project_id (project_id)
- INDEX idx_uml_diagrams_type (diagram_type)
- INDEX idx_uml_diagrams_created_at (created_at)
- INDEX idx_uml_diagrams_deleted_at (deleted_at)
- INDEX idx_uml_diagrams_project_created (project_id, created_at)

### notifications
- PRIMARY KEY (id)
- UNIQUE KEY (seq_id)
- INDEX idx_notifications_user_id (user_id)
- INDEX idx_notifications_project_id (project_id)
- INDEX idx_notifications_is_read (is_read)
- INDEX idx_notifications_created_at (created_at)
- INDEX idx_notifications_deleted_at (deleted_at)
- INDEX idx_notifications_user_created (user_id, created_at)

### ai_processing_logs
- PRIMARY KEY (id)
- UNIQUE KEY (seq_id)
- INDEX idx_ai_processing_logs_project_id (project_id)
- INDEX idx_ai_processing_logs_created_at (created_at)
- INDEX idx_ai_processing_logs_project_created (project_id, created_at)

### project_invitations
- PRIMARY KEY (id)
- UNIQUE KEY (seq_id)
- INDEX idx_project_invitations_inviter (inviter_user_id)
- INDEX idx_project_invitations_invitee (invitee_email)
- INDEX idx_project_invitations_project (project_id)
- INDEX idx_project_invitations_status (invitation_status)
- INDEX idx_project_invitations_created (inviter_user_id, created_at)

### user_favorites
- PRIMARY KEY (id)
- UNIQUE KEY (seq_id)
- UNIQUE KEY uk_user_project_favorite (user_id, project_id)
- INDEX idx_user_favorites_user_id (user_id)
- INDEX idx_user_favorites_project_id (project_id)
- INDEX idx_user_favorites_created (user_id, created_at)

## 4. MySQL policies (if applicable)

This schema implements soft delete patterns throughout by including a `deleted_at` column in most tables. Application-level logic should be implemented to:
1. Filter out records where `deleted_at` IS NOT NULL in all queries
2. Update the `deleted_at` field instead of actually deleting records
3. Handle cascading soft deletes where appropriate

Row-level security is implemented through application-level checks using user_id foreign keys and middleware rather than database-level policies.

## 5. Additional notes or explanations about design decisions

1. **Soft Delete Implementation**: All major entities use a `deleted_at` DATETIME for soft deletion, allowing for data recovery and maintaining referential integrity.

2. **Full-Text Search**: Projects table includes full-text indexes on business process text and name/description for efficient searching.

3. **Composite Indexes**: Sticky notes use composite indexes on position coordinates for efficient canvas rendering. Additional composite indexes on (user_id, created_at) and (project_id, created_at) optimize chronological queries.

4. **ENUM Types**: Used for categorical data like sticky note types, diagram types, and statuses to ensure data integrity and improve performance.

5. **UUID Identifiers**: All primary keys use VARCHAR(36) to store UUIDs, providing global uniqueness without requiring auto-increment.

6. **Sequential IDs**: All major tables include auto-increment `seq_id` columns for efficient ordering and pagination.

7. **DATETIME vs TIMESTAMP**: All timestamp columns use DATETIME instead of TIMESTAMP to avoid the 2038 year problem, supporting dates far into the future.

8. **Timestamps**: All tables include created_at and updated_at timestamps for audit purposes, with automatic updating.

9. **Relationships**: Complex relationships between sticky notes are stored in a separate table to support future editing features.

10. **Scalability**: LONGTEXT fields are used for large content storage like business process descriptions and UML diagrams.

11. **Future-Proofing**: Tables for notifications, invitations, and favorites are included to support future collaboration features.

12. **AI Integration**: Dedicated fields and tables for tracking AI processing status and confidence scores.
